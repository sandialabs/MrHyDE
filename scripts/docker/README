# Building a MrHyDE Docker Container

This folder contains a `Dockerfile` which builds all the _dependencies_ of MrHyDE (though, notably, currently _does not build MrHyDE itself_). This is intended to be used for working with a serial implementation of MrHyDE and, as such, does not compile Trilinos with OpenMP or other possible parallel bindings. The reason MrHyDE is not incorporated here is that any changes to the repository (which you have presumably already cloned) should be represented on the host and not lost in the docker container, i.e., this repository should be mounted as a docker volume.

## How to use

### First time setup
First, ensure that `docker engine` is installed (see instructions [here](https://docs.docker.com/engine/install/)). Then, with your shell in this directory, you should be able to execute `docker build -t mrhyde:serial_dev .` (note the `.`). This will create an image (*not* a container). You can see what you created using the `docker images` command; this should be named `mrhyde:serial_dev`.

This will take, depending on your computer (and its number of cores), up to an hour or more. However, for a given configuration of Trilinos/HDF5/OpenMPI/etc, this is a one-time step, and this image will persist across boots.

### Running the container and building MrHyDE
Assuming that your path to this repository (i.e., to the base directory of the repository) is set as `$MRHYDE_SRC`. Then, you can execute 

```
docker run -itd -v $MRHYDE_SRC:/git-repos/MrHyDE mrhyde:serial_dev
```

This command will echo out a long `SHA` string (`Digest: sha256:<CONTAINER SHA>`) and spawn a container that will run until you `stop` it or reboot, which contains your git repository mounted at `/git-repos/MrHyDE`; any changes you make on your host at `$MRHYDE_SRC` will be reflected in real time in the container, and vice versa.

## Using this image
### Shell usage
One possible workflow is to open up your preferred IDE and edit MrHyDE as needed. Then, when you want to test changes, run
```
docker exec -it <CONTAINER SHA> bash
```
where `<CONTAINER SHA>` should match the above (or just take the first four or so characters). This will open up a terminal *within* the container. Then, one can do, e.g.
```
$ mkdir /git-repos/MrHyDE/build
$ cd /git-repos/MrHyDE/build
$ cmake \
    -D CMAKE_CXX_STANDARD=17 \
    -GNinja \
    -DTrilinos_SRC_DIR=/git-repos/Trilinos/ \
    -DTrilinos_INSTALL_DIR=/usr/local \
    -DCMAKE_CXX_FLAGS=" -Wall" \
    ..
$ cd ../regression
$ ln -s ../build/src/mrhyde
$ ./runtests.py
```

### VS Code
If your preferred editor is VS Code, you can use the [`Dockerfile`](https://containers.dev/guide/dockerfile#dockerfile) to configure a dev container using the Remote: Dev Containers extension

## Notes
### Dev notes
If you are interested in changing the dependencies (e.g., compiling using a version of Trilinos with OpenMP/GPU compatibility) then, assuming your shell is in this directory, you can change the Trilinos config in `config_trilinos.sh` and add any necessary dependencies in the `Dockerfile`. Then, build the container again.

If you make changes to the container you'd like to save as an image for one reason or another, look into the `docker commit` command.

### TODO
This Docker container is known to fail the `porous/Mixed_hybrid_highorder` test. The cause of this failure is currently unknown.